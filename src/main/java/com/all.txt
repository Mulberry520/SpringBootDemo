==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\common\CommonConst.java ====
package com.mulberry.common;

public class CommonConst {
    public static final String SUCCESS_RESULT = "Operation success";
    public static final String ERROR_RESULT = "Operation failed";

    public static final int SUCCESS_CODE = 0;
    public static final int ERROR_CODE = 1;
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\common\R.java ====
package com.mulberry.common;


import lombok.Data;

@Data
public class R<T> {
    private Integer code;
    private String msg;
    private T data;

    private static <DATA> R<DATA> of(int code, String msg, DATA data) {
        R<DATA> r = new R<>();
        r.code = code;
        r.msg = msg;
        r.data = data;
        return r;
    }

    public static <DATA> R<DATA> success(String msg, DATA data) {
        return R.of(CommonConst.SUCCESS_CODE, msg, data);
    }

    public static <DATA> R<DATA> success(DATA data) {
        return R.of(CommonConst.SUCCESS_CODE, CommonConst.SUCCESS_RESULT, data);
    }

    public static <DATA> R<DATA> success(String msg) {
        return R.of(CommonConst.SUCCESS_CODE, msg, null);
    }

    public static <DATA> R<DATA> success() {
        return R.of(CommonConst.SUCCESS_CODE, CommonConst.SUCCESS_RESULT, null);
    }

    public static <DATA> R<DATA> error(int code, String msg) {
        return R.of(code, msg, null);
    }

    public static <DATA> R<DATA> error(String msg) {
        return R.of(CommonConst.ERROR_CODE, msg, null);
    }

    public static <DATA> R<DATA> error() {
        return R.of(CommonConst.ERROR_CODE, CommonConst.ERROR_RESULT, null);
    }

    public static <T> R<T> handlerResult(T result, String msg) {
        if (result != null) {
            return R.success(result);
        }
        return R.error(msg);
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\config\FilterConfig.java ====
package com.mulberry.config;

import com.mulberry.filter.TimingFilter;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class FilterConfig {
    @Bean
    public FilterRegistrationBean<TimingFilter> timingFilterRegistration() {
        FilterRegistrationBean<TimingFilter> registration = new FilterRegistrationBean<>();
        registration.setFilter(new TimingFilter());
        registration.addUrlPatterns("/*");
        registration.setOrder(1);
        return registration;
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\config\SecurityConfig.java ====
package com.mulberry.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.mulberry.common.R;
import com.mulberry.filter.JwtAuthenticationFilter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpStatus;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.CsrfConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
public class SecurityConfig {
    private final ObjectMapper objectMapper;
    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    public SecurityConfig(ObjectMapper objectMapper, JwtAuthenticationFilter jwtAuthenticationFilter) {
        this.objectMapper = objectMapper;
        this.jwtAuthenticationFilter = jwtAuthenticationFilter;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .csrf(CsrfConfigurer::disable)
                .sessionManagement(session -> session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                )
                .authorizeHttpRequests(authorize -> authorize
                        .requestMatchers("/api/user/**").permitAll()
                        .anyRequest().authenticated()
                )
                .exceptionHandling(ex -> ex
                        .authenticationEntryPoint((request, response, authException) -> {
                            response.setStatus(HttpStatus.UNAUTHORIZED.value());
                            response.getWriter().write(objectMapper.writeValueAsString(R.error(401, "Unauthorized")));
                        })
                )
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\config\WebConfig.java ====
package com.mulberry.config;

import com.mulberry.interceptor.LoginInterceptor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {
    private final LoginInterceptor loginInterceptor;

    public WebConfig(LoginInterceptor loginInterceptor) {
        this.loginInterceptor = loginInterceptor;
    }

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "PATCH")
                .allowedHeaders("*");
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(loginInterceptor)
                .addPathPatterns("/profile")
                .excludePathPatterns("/api/**");
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\controller\ArticleController.java ====
package com.mulberry.controller;

import com.mulberry.common.R;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/article")
public class ArticleController {
    @GetMapping("/")
    public R<Void> hello() {
        return R.success("this is article page");
    }

}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\controller\FileLoadController.java ====
package com.mulberry.controller;

import com.mulberry.common.R;
import com.mulberry.service.FileService;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@Controller
@RequestMapping("/api/file")
public class FileLoadController {
    private final FileService fileService;

    public FileLoadController(FileService fileService) {
        this.fileService = fileService;
    }

    @GetMapping("/test")
    public String fileTest() {
        return "upload";
    }


    @PostMapping("/upload")
    @ResponseBody
    public R<String> uploadFile(
            @RequestParam("title") String title,
            @RequestParam("description") String desc,
            @RequestParam("file") MultipartFile file
    ) {
        System.out.println("title = " + title);
        System.out.println("desc = " + desc);

        try {
            fileService.saveFile(file);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }

        return R.success("File upload success");
    }

    @PostMapping("/uploads")
    @ResponseBody
    public R<String> multiUploadFile(
            @RequestParam("title") String title,
            @RequestParam("description") String desc,
            @RequestParam("files") MultipartFile[] files
    ) {
        System.out.println("title = " + title);
        System.out.println("desc = " + desc);

        for (MultipartFile file : files) {
            try {
                fileService.saveFile(file);
            } catch (Exception e) {
                return R.error(e.getMessage());
            }
        }
        return R.success("All files upload success");
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\controller\GlobalExceptionHandler.java ====
package com.mulberry.controller;

import com.mulberry.common.R;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler
    public R<Void> handleException(Exception e) {
        // handler different exceptions...

        return R.error(e.getMessage());
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\controller\UserController.java ====
package com.mulberry.controller;

import com.mulberry.common.R;
import com.mulberry.dto.LoginDTO;
import com.mulberry.dto.UserDTO;
import com.mulberry.service.UserService;
import com.mulberry.util.JwtUtil;
import jakarta.validation.Valid;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/user")
public class UserController {
    private final UserService userService;
    private final PasswordEncoder passwordEncoder;
    private final JwtUtil jwtUtil;

    public UserController(PasswordEncoder passwordEncoder, UserService userService, JwtUtil jwtUtil) {
        this.passwordEncoder = passwordEncoder;
        this.userService = userService;
        this.jwtUtil = jwtUtil;
    }

    @PostMapping("/register")
    public R<Void> register(@RequestBody @Valid UserDTO user) {
        if (userService.findByName(user.getUsername()) != null) {
            return R.error("Username already exists");
        }

        String encodedPasswd = passwordEncoder.encode(user.getPassword());
        user.setPassword(encodedPasswd);
        int affected =  userService.register(user);
        return R.success("Successfully insert " + affected + " user");
    }

    @PostMapping("/login")
    public R<String> login(@RequestBody @Valid LoginDTO user) {
        String name = user.getUsername();
        UserDTO target = userService.findByName(name);
        if (target == null) {
            return R.error("Not exists this user");
        }

        if (!passwordEncoder.matches(user.getPassword(), target.getPassword())) {
            return R.error("Wrong password");
        }
        return R.success(jwtUtil.generateToken(name));
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\dto\LoginDTO.java ====
package com.mulberry.dto;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;
import lombok.Data;

@Data
public class LoginDTO {
    @NotBlank
    @Size(min = 4, max = 16)
    @Pattern(regexp = "^[a-zA-Z0-9_]+$")
    private String username;

    @NotBlank
    @Size(max = 64)
    private String password;
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\dto\UserDTO.java ====
package com.mulberry.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import jakarta.validation.constraints.Size;
import lombok.Data;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.util.Collection;
import java.util.Collections;

@Data
public class UserDTO implements UserDetails {
    @NotBlank
    @Size(min = 4, max = 16)
    @Pattern(regexp = "^[a-zA-Z0-9_]+$")
    private String username;

    @NotBlank
    @Size(min = 6, max = 64)
    private String password;

    @Size(max = 64)
    private String nickname;
    @Email
    @Size(max = 64)
    private String email;
    @Size(max = 128)
    private String userPic;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return Collections.emptyList();
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\entity\Article.java ====
package com.mulberry.entity;


import lombok.Data;

import java.time.LocalDateTime;

@Data
public class Article {
    private Integer id;
    private String title;
    private String content;
    private String coverImg;
    private String state;
    private Integer categoryId;
    private Integer createUser;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\entity\Category.java ====
package com.mulberry.entity;

import lombok.Data;

import java.time.LocalDateTime;

@Data
public class Category {
    private Integer id;
    private String categoryName;
    private String categoryAlias;
    private Integer createUser;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\entity\User.java ====
package com.mulberry.entity;

import lombok.Data;

import java.time.LocalDateTime;

@Data
public class User {
    private Integer id;
    private String username;
    private String password;
    private String nickname;
    private String email;
    private String userPic;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\filter\JwtAuthenticationFilter.java ====
package com.mulberry.filter;

import com.mulberry.dto.UserDTO;
import com.mulberry.service.UserService;
import com.mulberry.util.JwtUtil;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    private final JwtUtil jwtUtil;

    private final UserService userService;

    public JwtAuthenticationFilter(JwtUtil jwtUtil, UserService userService) {
        this.jwtUtil = jwtUtil;
        this.userService = userService;
    }


    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain
    ) throws ServletException, IOException {
        final String header = request.getHeader("Authorization");
        final String authority = "Bearer ";
        String username = null;
        String token = null;

        if (header != null && header.startsWith(authority)) {
            token = header.substring(authority.length());
            try {
                username = jwtUtil.extractUsername(token);
            } catch (Exception e) {
                logger.warn("Invalid JWT token: " + e.getMessage());
                username = null;
            }
        }

        if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDTO user = userService.findByName(username);
            if (user != null && jwtUtil.validateToken(token, username)) {
                UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(user, null);
                authenticationToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(authenticationToken);
            }
        }

        filterChain.doFilter(request, response);
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\filter\TimingFilter.java ====
package com.mulberry.filter;

import jakarta.servlet.*;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.stereotype.Component;

import java.io.IOException;

public class TimingFilter implements Filter {

    @Override
    public void doFilter(
            ServletRequest servletRequest,
            ServletResponse servletResponse,
            FilterChain filterChain
    ) throws IOException, ServletException {
        long startTime = System.currentTimeMillis();
        HttpServletRequest request = (HttpServletRequest) servletRequest;
        System.out.println("Request URL: " + request.getRequestURI());

        filterChain.doFilter(servletRequest, servletResponse);

        long totalTime = System.currentTimeMillis() - startTime;
        System.out.println("Total time = " + totalTime + "ms");
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\interceptor\LoginInterceptor.java ====
package com.mulberry.interceptor;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

@Component
public class LoginInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(
            HttpServletRequest request,
            HttpServletResponse response,
            Object handler
    ) throws Exception {
        return true;
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\mapper\UserMapper.java ====
package com.mulberry.mapper;

import com.mulberry.dto.UserDTO;
import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

@Mapper
public interface UserMapper {
    @Select("select * from users where username = #{username}")
    UserDTO selectByName(@Param("username") String name);

    @Insert("insert into users (username, password, nickname, email, user_pic) values (#{username}, #{password}, #{nickname}, #{email}, #{user_pic})")
    int insertWithBasicInfo(
            @Param("username") String name,
            @Param("password") String passwd,
            @Param("nickname") String nickname,
            @Param("email") String email,
            @Param("user_pic") String userPic
    );
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\service\impl\FileServiceImpl.java ====
package com.mulberry.service.impl;

import com.mulberry.service.FileService;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.UUID;

@Service
public class FileServiceImpl implements FileService {
    @Value("${app.upload-dir:uploads}")
    private String uploadDir;

    @Override
    public void saveFile(MultipartFile file) throws IOException {
        if (file.isEmpty()) {
            throw new IllegalArgumentException("Empty file");
        }

        Path rootLocation = Paths.get(this.uploadDir).toAbsolutePath().normalize();
        try {
            Files.createDirectories(rootLocation);
        } catch (IOException e) {
            throw new RuntimeException("Can't create upload directory");
        }

        String filename = file.getOriginalFilename();
        if (filename == null || filename.isBlank()) {
            throw new IllegalArgumentException("Illegal file name");
        }
        String extension = "";
        int lastDot = filename.lastIndexOf(".");
        if (lastDot > 0) {
            extension = filename.substring(lastDot);
        }

        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyMMdd_HHmmss_"));
        String randomId = UUID.randomUUID().toString().substring(0, 6);
        String savedName = timestamp + randomId + extension;
        Path destination = rootLocation.resolve(savedName);
        Files.copy(file.getInputStream(), destination);
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\service\impl\UserServiceImpl.java ====
package com.mulberry.service.impl;

import com.mulberry.dto.UserDTO;
import com.mulberry.entity.User;
import com.mulberry.mapper.UserMapper;
import com.mulberry.service.UserService;
import org.springframework.stereotype.Service;

@Service
public class UserServiceImpl implements UserService {
    private final UserMapper mapper;

    public UserServiceImpl(UserMapper mapper) {
        this.mapper = mapper;
    }

    @Override
    public UserDTO findByName(String name) {
        return mapper.selectByName(name);
    }

    @Override
    public int register(UserDTO user) {
        return mapper.insertWithBasicInfo(
                user.getUsername(),
                user.getPassword(),
                user.getNickname(),
                user.getEmail(),
                user.getUserPic()
        );
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\service\FileService.java ====
package com.mulberry.service;

import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

public interface FileService {
    void saveFile(MultipartFile file) throws IOException;
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\service\UserService.java ====
package com.mulberry.service;

import com.mulberry.dto.UserDTO;

public interface UserService {
    UserDTO findByName(String name);

    int register(UserDTO user);
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\util\JwtUtil.java ====
package com.mulberry.util;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Date;

@Component
public class JwtUtil {
    @Value("${jwt.secret}")
    private String SECRET_KEY;

    @Value("${jwt.expiration}")
    private long EXPIRATION;

    private SecretKey getSigningKey() {
        byte[] keyBytes = SECRET_KEY.getBytes(StandardCharsets.UTF_8);
        return Keys.hmacShaKeyFor(keyBytes);
    }

    private Claims getClaims(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(getSigningKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    private boolean isTokenExpired(String token) {
        return getClaims(token).getExpiration().before(new Date());
    }

    public String generateToken(String username) {
        return Jwts.builder()
                .setSubject(username)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION))
                .signWith(getSigningKey())
                .compact();
    }

    public boolean validateToken(String token, String username) {
        if (isTokenExpired(token)) {
            return false;
        }

        final String extractedUsername = extractUsername(token);
        return extractedUsername.equals(username);
    }

    public String extractUsername(String token) {
        return getClaims(token).getSubject();
    }
}
==== FILE: C:\java\javaCoding\SpringBootDemo\src\main\java\com\mulberry\SpringBootDemoApplication.java ====
package com.mulberry;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.PropertySource;

@SpringBootApplication
@MapperScan("com.mulberry.mapper")
@PropertySource("classpath:secret.properties")
public class SpringBootDemoApplication {

    public static void main(String[] args) {
        SpringApplication.run(SpringBootDemoApplication.class, args);
    }

}
